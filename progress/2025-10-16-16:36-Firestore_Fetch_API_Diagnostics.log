# Firestore Fetch API Diagnostics and Fixes

## Data: 2025-10-16 16:36:09 CEST

## Problem:
UÅ¼ytkownik zgÅ‚osiÅ‚ bÅ‚Ä™dy Fetch API Firestore po odÅ›wieÅ¼eniu stron, szczegÃ³lnie na stronach ustawieÅ„ i kalendarza:

```
Fetch API cannot load https://firestore.googleapis.com/google.firestore.v1.Firestore/Listen/channel?gsessionid=... due to access control checks.
```

## Analiza przyczyn:

### 1. **NiezgodnoÅ›Ä‡ regionÃ³w:**
- Firestore: `eur3` (Europa Zachodnia)
- Functions: `europe-central2` (Frankfurt)
- Firebase Auth: domyÅ›lnie w USA

### 2. **Problem z konfiguracjÄ… Firestore:**
- UÅ¼ywany `experimentalAutoDetectLongPolling: true` powodujÄ…cy problemy na produkcji
- Brak odpowiedniej obsÅ‚ugi bÅ‚Ä™dÃ³w sieciowych

### 3. **Brak diagnostyki:**
- Brak logowania stanu uwierzytelniania
- Brak przechwytywania bÅ‚Ä™dÃ³w Firestore

## Przeprowadzone poprawki:

### 1. **Poprawa konfiguracji Firestore** (`admin-frontend/src/lib/firebase.ts`)

#### Przed:
```typescript
dbInstance = initializeFirestore(app, {
  experimentalAutoDetectLongPolling: true,
});
```

#### Po:
```typescript
dbInstance = initializeFirestore(app, {
  experimentalAutoDetectLongPolling: false,
  cacheSizeBytes: 4096 * 4096, // 16MB cache
});
```

### 2. **Dodanie diagnostyki uwierzytelniania** (`admin-frontend/src/lib/firebase.ts`)

```typescript
// Dodaj diagnostykÄ™ uwierzytelniania
if (typeof window !== "undefined") {
  auth.onAuthStateChanged((user) => {
    if (user) {
      console.log('âœ… Firebase Auth: User authenticated', user.uid);
      // SprawdÅº token
      user.getIdToken().then((token) => {
        console.log('âœ… Firebase Auth: Token valid');
      }).catch((error) => {
        console.error('âŒ Firebase Auth: Token error', error);
      });
    } else {
      console.log('âš ï¸ Firebase Auth: User not authenticated');
    }
  });

  // ObsÅ‚uga bÅ‚Ä™dÃ³w uwierzytelniania
  auth.onIdTokenChanged(() => {
    console.log('ğŸ”„ Firebase Auth: Token changed');
  });
}
```

### 3. **Dodanie globalnych handlerÃ³w bÅ‚Ä™dÃ³w** (`admin-frontend/src/lib/firebase.ts`)

```typescript
// Dodaj globalny handler bÅ‚Ä™dÃ³w Firestore
if (typeof window !== "undefined") {
  // Przechwytuj bÅ‚Ä™dy sieciowe Firestore
  window.addEventListener('error', (event) => {
    if (event.message && event.message.includes('firestore.googleapis.com')) {
      console.error('âŒ Firestore Network Error:', {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        online: navigator.onLine
      });
    }
  });

  // Przechwytuj bÅ‚Ä™dy Promise ( Firestore uÅ¼ywa Promise )
  window.addEventListener('unhandledrejection', (event) => {
    if (event.reason && event.reason.message && event.reason.message.includes('firestore.googleapis.com')) {
      console.error('âŒ Firestore Promise Rejection:', {
        reason: event.reason,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        online: navigator.onLine
      });
    }
  });

  // Logowanie stanu poÅ‚Ä…czenia
  window.addEventListener('online', () => {
    console.log('ğŸŒ Network: Online');
  });

  window.addEventListener('offline', () => {
    console.log('ğŸ“µ Network: Offline');
  });
}
```

### 4. **Ujednolicenie regionÃ³w Firebase** (`firebase.json`)

#### Przed:
```json
{
  "firestore": {
    "database": "(default)",
    "location": "eur3",
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
```

#### Po:
```json
{
  "firestore": {
    "database": "(default)",
    "location": "europe-central2",
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
```

## WdroÅ¼enie:
- Zmiany zostaÅ‚y zbudowane pomyÅ›lnie (`npm run build`)
- WdroÅ¼one na Firebase Hosting (`firebase deploy --only hosting`)
- Aplikacja dostÄ™pna pod adresem: https://salonbeautymario-x1.web.app

## Oczekiwane rezultaty:
1. **Eliminacja bÅ‚Ä™dÃ³w Fetch API:** Poprawa konfiguracji Firestore powinna rozwiÄ…zaÄ‡ problemy z dostÄ™pem
2. **Lepsza diagnostyka:** Logi pomogÄ… zidentyfikowaÄ‡ przyczyny przyszÅ‚ych problemÃ³w
3. **SpÃ³jnoÅ›Ä‡ regionÃ³w:** Ujednolicenie regionÃ³w powinno poprawiÄ‡ komunikacjÄ™ miÄ™dzy usÅ‚ugami

## Monitorowanie:
- W konsoli przeglÄ…darki pojawiÄ… siÄ™ szczegÃ³Å‚owe logi diagnostyczne
- BÅ‚Ä™dy Firestore bÄ™dÄ… teraz lepiej dokumentowane
- Stan uwierzytelniania bÄ™dzie monitorowany w czasie rzeczywistym

## Pliki zmodyfikowane:
- `admin-frontend/src/lib/firebase.ts` - poprawa konfiguracji i dodanie diagnostyki
- `firebase.json` - zmiana regionu Firestore na `europe-central2`

## Uwagi:
- Zmiana regionu Firestore moÅ¼e wymagaÄ‡ ponownego wdroÅ¼enia reguÅ‚ i indeksÃ³w
- Diagnostyka zostaÅ‚a dodana tylko dla Å›rodowiska przeglÄ…darki (typeof window !== "undefined")
- Dodatkowe logowanie moÅ¼na usunÄ…Ä‡ po rozwiÄ…zaniu problemÃ³w z wydajnoÅ›ciÄ…